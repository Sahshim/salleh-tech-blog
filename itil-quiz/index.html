<body>
  <!-- START SCREEN -->
  <div class="quiz-container" id="start-screen">
    <h2>Welcome to the ITIL Adaptive Quiz</h2>
    <p>Test your knowledge and track your progress.</p>
    <button onclick="startQuiz()" style="padding: 1rem; font-size: 1rem;">Start Quiz</button>
  </div>

  <!-- QUIZ SECTION (initially hidden) -->
  <div class="quiz-container" id="quiz-section" style="display: none;">
    <div class="question-image">
      <img src="" alt="concept" id="icon" />
    </div>
    <h2 id="question">Loading...</h2>
    <div class="options" id="options"></div>
    <div class="score" id="score"></div>
    <div class="timer" id="timer">Time: 00:00</div>
    <button class="next" onclick="nextQuestion()">Next Question</button>
    <div class="chart-container">
      <canvas id="progressChart"></canvas>
      <div class="pagination" id="chartPagination"></div>
      <div class="filters">
        <label><input type="checkbox" id="filterIncorrect" onchange="drawChart()"> Show only incorrect terms</label>
      </div>
      <div id="accordion"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const currentUser = "Salleh";
    const userProgress = JSON.parse(localStorage.getItem(`progress_${currentUser}`)) || [];

    // New: handle quiz start visibility toggle
    function startQuiz() {
      document.getElementById('start-screen').style.display = 'none';
      document.getElementById('quiz-section').style.display = 'block';
      startTimer();
      loadQuestion();
    }

    fetch('itil_data_10_final.json')
      .then(response => response.json())
      .then(allData => {
        const selected = allData.sort(() => 0.5 - Math.random()).slice(0, 10);

        const quizData = selected.map(item => {
          const distractors = allData
            .filter(d => d.term !== item.term)
            .sort(() => 0.5 - Math.random())
            .slice(0, 3)
            .map(d => d.term);

          return {
            question: item.definition,
            correct_answer: item.term,
            icon: `/assets/images/${encodeURIComponent(item.icon.replace(/ /g, '_'))}`,
            options: [...distractors, item.term].sort(() => 0.5 - Math.random())
          };
        });

        // Expose nextQuestion & drawChart globally
        window.nextQuestion = nextQuestion;
        window.drawChart = drawChart;

        // Save quizData globally for access by startQuiz
        window.quizData = quizData;

        let current = 0, score = 0, seconds = 0, timerInterval;
        const questionEl = document.getElementById('question');
        const optionsEl = document.getElementById('options');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const iconEl = document.getElementById('icon');

        function formatTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function loadQuestion() {
          const q = quizData[current];
          questionEl.innerHTML = `<strong>Definition:</strong> ${q.question}`;
          iconEl.src = q.icon;
          optionsEl.innerHTML = '';
          q.options.forEach(option => {
            const btn = document.createElement('button');
            btn.innerText = option;
            btn.onclick = () => {
              if (!btn.classList.contains('disabled')) {
                Array.from(optionsEl.children).forEach(b => b.classList.add('disabled'));
                checkAnswer(option, q.correct_answer, q.question);
              }
            };
            optionsEl.appendChild(btn);
          });
        }

        function checkAnswer(selected, correct, questionText) {
          const isCorrect = selected === correct;
          if (isCorrect) {
            score++;
            alert('✅ Correct!');
          } else {
            alert(`❌ Wrong! Correct answer: ${correct}`);
          }

          userProgress.push({
            user: currentUser,
            question: questionText,
            term: correct,
            selected: selected,
            correct: isCorrect,
            timestamp: new Date().toISOString()
          });

          scoreEl.innerText = `Score: ${score} / ${current + 1}`;
        }

        function nextQuestion() {
          current++;
          if (current >= quizData.length) {
            clearInterval(timerInterval);
            alert(`Quiz complete! Your score: ${score}/${quizData.length}. Time taken: ${formatTime(seconds)}`);
            localStorage.setItem(`progress_${currentUser}`, JSON.stringify(userProgress));
            drawChart();
            current = 0; score = 0; seconds = 0;
            userProgress.length = 0;
            startTimer();
            loadQuestion();
          } else {
            loadQuestion();
          }
        }

        function startTimer() {
          clearInterval(timerInterval);
          seconds = 0;
          timerEl.innerText = `Time: 00:00`;
          timerInterval = setInterval(() => {
            seconds++;
            timerEl.innerText = `Time: ${formatTime(seconds)}`;
            if (seconds >= 3600) {
              clearInterval(timerInterval);
              alert(`⏰ Time's up! Final score: ${score}/${quizData.length}`);
            }
          }, 1000);
        }

        function drawChart(page = 0, pageSize = 10) {
          const counts = {};
          userProgress.forEach(entry => {
            if (!counts[entry.term]) counts[entry.term] = { correct: 0, incorrect: 0, definition: entry.question };
            if (entry.correct) counts[entry.term].correct++;
            else counts[entry.term].incorrect++;
          });
          let allLabels = Object.keys(counts);
          if (document.getElementById('filterIncorrect').checked) {
            allLabels = allLabels.filter(label => counts[label].incorrect > 0);
          }
          const pageLabels = allLabels.slice(page * pageSize, (page + 1) * pageSize);
          const correctData = pageLabels.map(label => counts[label].correct);
          const incorrectData = pageLabels.map(label => counts[label].incorrect);

          const ctx = document.getElementById('progressChart');
          if (window.chartInstance) window.chartInstance.destroy();
          window.chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: pageLabels,
              datasets: [
                { label: 'Correct', data: correctData, backgroundColor: 'rgba(75, 192, 192, 0.7)' },
                { label: 'Incorrect', data: incorrectData, backgroundColor: 'rgba(255, 99, 132, 0.7)' }
              ]
            },
            options: {
              responsive: true,
              plugins: { legend: { position: 'top' }, title: { display: true, text: 'Your Progress by Term' } }
            }
          });

          const pagination = document.getElementById('chartPagination');
          pagination.innerHTML = `
            <button onclick="drawChart(${page - 1})" ${page <= 0 ? 'disabled' : ''}>⬅ Prev Page</button>
            Showing terms ${page * pageSize + 1}–${Math.min((page + 1) * pageSize, allLabels.length)} of ${allLabels.length}
            <button onclick="drawChart(${page + 1})" ${(page + 1) * pageSize >= allLabels.length ? 'disabled' : ''}>Next Page ➡</button>
          `;

          const accordion = document.getElementById('accordion');
          accordion.innerHTML = '';
          pageLabels.forEach(label => {
            const item = document.createElement('div');
            item.className = 'accordion-item';
            item.innerHTML = `<strong>${label}</strong>`;
            const content = document.createElement('div');
            content.className = 'accordion-content';
            content.innerText = counts[label].definition;
            item.appendChild(content);
            item.onclick = () => content.style.display = content.style.display === 'block' ? 'none' : 'block';
            accordion.appendChild(item);
          });
        }

        // expose for global use
        window.startQuiz = startQuiz;
        window.loadQuestion = loadQuestion;
      });
  </script>
</body>
