<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ITIL Adaptive Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<!-- LOGIN SCREEN -->
<div class="quiz-container p-6 max-w-xl mx-auto" id="login-screen">
  <h2 class="text-2xl font-bold text-center mb-4">ITIL Quiz Login</h2>
  <input type="email" id="email" placeholder="Email" class="border rounded-md p-2 w-full mb-4" />
  <input type="password" id="password" placeholder="Password" class="border rounded-md p-2 w-full mb-4" />
  <button onclick="firebaseLogin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full">Login / Register</button>
  <p id="login-error" class="text-red-500 mt-2"></p>
</div>

<!-- START SCREEN -->
<div class="quiz-container hidden p-6 max-w-xl mx-auto" id="start-screen">
  <h2 class="text-2xl font-bold mb-4">Welcome to the ITIL Adaptive Quiz</h2>
  <p class="mb-4">Test your knowledge and track your progress.</p>
  <button onclick="startQuiz()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Start Quiz</button>
</div>

<!-- QUIZ SECTION -->
<div class="quiz-container hidden p-6 max-w-3xl mx-auto" id="quiz-section">
  <div class="question-image text-center mb-4"><img src="" alt="concept" id="icon" class="max-h-40 mx-auto" /></div>
  <h2 id="question" class="text-xl font-semibold mb-4">Loading...</h2>
  <div class="options grid grid-cols-1 gap-2 mb-4" id="options"></div>
  <div class="score text-sm text-gray-700 mb-2" id="score"></div>
  <div class="timer text-sm text-gray-600 mb-2" id="timer">Time: 00:00</div>
  <button onclick="nextQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Next Question</button>
  <div class="chart-container mt-6">
    <canvas id="progressChart"></canvas>
    <div class="pagination mt-2" id="chartPagination"></div>
    <label class="block mt-2"><input type="checkbox" id="filterIncorrect" onchange="drawChart()"> Show only incorrect terms</label>
    <div id="accordion" class="mt-4"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDejvImoxjN5WW8UxOucCasDPwPNrhoPNc",
  authDomain: "itilmcq.firebaseapp.com",
  projectId: "itilmcq",
  storageBucket: "itilmcq.appspot.com",
  messagingSenderId: "535085938419",
  appId: "1:535085938419:web:8549b9b3d11dd26a756986",
  measurementId: "G-PW7SPRRLVW"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

function firebaseLogin() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const errorEl = document.getElementById('login-error');

  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('start-screen').style.display = 'block';
    })
    .catch(() => {
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('start-screen').style.display = 'block';
        })
        .catch(error => errorEl.textContent = error.message);
    });
}

const userProgress = JSON.parse(localStorage.getItem("progress_user")) || [];
let quizData = [], current = 0, score = 0, seconds = 0, timerInterval;
let questionEl, optionsEl, scoreEl, timerEl, iconEl;

function startTimer() {
  timerInterval = setInterval(() => {
    seconds++;
    const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
    const secs = String(seconds % 60).padStart(2, '0');
    timerEl.textContent = `Time: ${mins}:${secs}`;
  }, 1000);
}

function loadQuestion() {
  if (current >= quizData.length) return;
  const q = quizData[current];
  questionEl.textContent = q.question;
  iconEl.src = q.icon;
  optionsEl.innerHTML = '';

  q.options.forEach(option => {
    const btn = document.createElement('button');
    btn.textContent = option;
    btn.className = 'border rounded px-4 py-2 text-left bg-white hover:bg-gray-100';
    btn.onclick = () => {
      if (option === q.correct_answer) {
        score++;
        btn.classList.add('bg-green-200');
      } else {
        btn.classList.add('bg-red-200');
      }
      userProgress.push({ question: q.question, selected: option, correct: q.correct_answer });
      scoreEl.textContent = `Score: ${score}/${quizData.length}`;
    };
    optionsEl.appendChild(btn);
  });
}

function startQuiz() {
  document.getElementById('start-screen').style.display = 'none';
  document.getElementById('quiz-section').style.display = 'block';
  questionEl = document.getElementById('question');
  optionsEl = document.getElementById('options');
  scoreEl = document.getElementById('score');
  timerEl = document.getElementById('timer');
  iconEl = document.getElementById('icon');
  score = 0; current = 0; seconds = 0;
  userProgress.length = 0;
  startTimer();

  console.log("Fetching quiz data...");

  fetch('/itil-quiz/itil_data_10_final.json')
    .then(res => {
      if (!res.ok) throw new Error("Failed to load JSON");
      return res.json();
    })
    .then(allData => {
      console.log("Data loaded:", allData.length);
      const selected = allData.sort(() => 0.5 - Math.random()).slice(0, 10);
      quizData = selected.map(item => {
        const distractors = allData
          .filter(d => d.term !== item.term)
          .sort(() => 0.5 - Math.random())
          .slice(0, 3)
          .map(d => d.term);
        const iconPath = item.icon ? `/assets/images/${encodeURIComponent(item.icon.replace(/ /g, '_'))}` : 'default.png';
        console.log(`Loading icon for ${item.term}:`, iconPath);
        return {
          question: item.definition,
          correct_answer: item.term,
          icon: iconPath,
          options: [...distractors, item.term].sort(() => 0.5 - Math.random())
        };
      });
      loadQuestion();
    })
    .catch(err => {
      console.error("Error loading quiz data:", err);
      questionEl.textContent = "Error loading quiz data.";
    });
}
</script>
</body>
</html>
